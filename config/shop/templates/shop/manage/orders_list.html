{%extends 'shop/base.html'%}
{%block title%}Orders{%endblock%}

{%block content%}
<section class="panel">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2 style="margin:0;">Orders</h2>
        <a class="btn" href="{%url 'shop:manage_dashboard'%}">Dashboard</a>
    </div>

    <form method="get" style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;">
        <input type="text" class="inputqty" name="q" value="{{q}}" placeholder="Search (id, name, email)">
        <select name="status">
            <option value="">All statuses</option>
            {%for key,label in status_choices%}
            <option value="{{key}}" {% if status|default:''==key %}selected{%endif%}>{{label}}</option>
            {%endfor%}
        </select>
        <select name="paid">
            <option value="">Paid: all</option>
            <option value="yes" {%if paid='yes'%}selected{%endif%}>Paid</option>
            <option value="no" {%if paid='no'%}selected{%enif%}>Not paid</option>
        </select>
        <button class="btn btn--primary" type="submit">Apply</button>
        <a href="{%url 'shop:manage_orders'%}" class="btn">Reset</a>
    </form>

    <form action="{%url 'shop:manage_orders_bulk_status'%}" method="post" style="margin-top:12px">
        {%csrf_token%}
        <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px;">
            <button class="btn" type="button" onclick="toggleAll(true)">Select all</button>
            <button class="btn" type="button" onclick="toggleAll(false)">Clear</button>
            <select name="status" required>
                <option value="" disabled selected>Set Status...</option>
                {%for key,label in status_choices%}
                <option value="{{key}}">{{label}}</option>
                {%endfor%}
            </select>
            <button class="btn btn--primaary" type="submit">Update selected</button>
            <!--nachat otsuda na sleduyushem zanyatii-->
        </div>
    

    <table style="width:100%; border-collapse:collapse; margin-top:12px;">
        <tr>
            <th align="left">#</th>
            <th align="left">Created</th>
            <th align="left">Customer</th>
            <th align="left">Paid</th>
            <th align="left">Total</th>
            <th align="left">Status</th>
            <th></th>
        </tr>
        {%for o in orders%}
        <tr>
            <td>{{o.id}}</td>
            <td>{{o.created}}</td>
            <td>{{o.first_name}} {{o.last_name}}</td>
            <td>{%if o.paid%}Yes{%else%}No{%endif%}</td>
            <td>{{o.total}}$</td>
            <td>{{o.status}}</td>
            <td><a class="btn" href="{%url 'shop:manage_order_detail' o.id%}">Open</a></td>
        </tr>
        {%empty%}
        <tr><td colspan="7" class="muted">No orders</td></tr>
        {%endfor%}
    </table>
    </form>
    {%if page_obj%}
    <div style="display:flex; gap:10px; align-items:center; margin-top:14px;">
        {%if page_obj.has_previous%}
        <a class="btn"href="?q={{q}}&status={{status}}&paid={{paid}}&page={{page_obj.previous_page_number}}">Prev</a>
        {%endif%}
        <div class="muted">Page {{page_obj.number}}/{{page_obj.paginator.num_pages}}</div>
        {%if page_obj.has_next%}
        <a class="btn"href="?q={{q}}&status={{status}}&paid={{paid}}&page={{page_obj.next_page_number}}">Next</a>
        {%endif%}
    </div>
    {%endif%}
</section>
<script>
    function toggleAll(state){
        document.querySelectorAll('.order-cb').forEach(cb=>cb.checked=state);
    }
</script>
{%endblock%}